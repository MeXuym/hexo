<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="轮子,动画," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="项目中有一个页面为了满足设计把导航栏隐藏了，要跳转的下一界面则有导航栏，引发了如上图的问题，push和pop没有了平滑的切换动画，导航栏是突然出现和消失。做了一些尝试但始终达不到想要的效果，直到google到下面这一个解决思路。废话不多说，直入主题。
解决思路1.自定义push和pop动画(点击查看我这一部分的分享)。2.push或者pop的同时执行我们自己的切换动画，用户看到的是我们自己的动画">
<meta property="og:type" content="article">
<meta property="og:title" content="非全部导航栏显示的导航动画问题">
<meta property="og:url" content="http://yoursite.com/2016/12/08/非全部导航栏显示的导航动画问题/index.html">
<meta property="og:site_name" content="Xuym">
<meta property="og:description" content="项目中有一个页面为了满足设计把导航栏隐藏了，要跳转的下一界面则有导航栏，引发了如上图的问题，push和pop没有了平滑的切换动画，导航栏是突然出现和消失。做了一些尝试但始终达不到想要的效果，直到google到下面这一个解决思路。废话不多说，直入主题。
解决思路1.自定义push和pop动画(点击查看我这一部分的分享)。2.push或者pop的同时执行我们自己的切换动画，用户看到的是我们自己的动画">
<meta property="og:image" content="https://raw.githubusercontent.com/MeXuym/hexoSource/master/_posts/XYMNavigation/NativeNavigation.gif">
<meta property="og:image" content="https://raw.githubusercontent.com/MeXuym/hexoSource/master/_posts/XYMNavigation/pushandpop.gif">
<meta property="og:image" content="https://raw.githubusercontent.com/MeXuym/hexoSource/master/_posts/XYMNavigation/XYMNavigation.gif">
<meta property="og:updated_time" content="2017-02-17T03:31:18.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="非全部导航栏显示的导航动画问题">
<meta name="twitter:description" content="项目中有一个页面为了满足设计把导航栏隐藏了，要跳转的下一界面则有导航栏，引发了如上图的问题，push和pop没有了平滑的切换动画，导航栏是突然出现和消失。做了一些尝试但始终达不到想要的效果，直到google到下面这一个解决思路。废话不多说，直入主题。
解决思路1.自定义push和pop动画(点击查看我这一部分的分享)。2.push或者pop的同时执行我们自己的切换动画，用户看到的是我们自己的动画">
<meta name="twitter:image" content="https://raw.githubusercontent.com/MeXuym/hexoSource/master/_posts/XYMNavigation/NativeNavigation.gif">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 非全部导航栏显示的导航动画问题 | Xuym </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Xuym</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                非全部导航栏显示的导航动画问题
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-08T23:47:44+08:00" content="2016-12-08">
              2016-12-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2016/12/08/非全部导航栏显示的导航动画问题/" class="leancloud_visitors" data-flag-title="非全部导航栏显示的导航动画问题">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="https://raw.githubusercontent.com/MeXuym/hexoSource/master/_posts/XYMNavigation/NativeNavigation.gif" alt="NativeNavigation"></p>
<p>项目中有一个页面为了满足设计把导航栏隐藏了，要跳转的下一界面则有导航栏，引发了如上图的问题，push和pop没有了平滑的切换动画，导航栏是突然出现和消失。做了一些尝试但始终达不到想要的效果，直到google到下面这一个解决思路。废话不多说，直入主题。</p>
<h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><p>1.自定义push和pop动画(点击查看我这一部分的分享)。<br>2.push或者pop的同时执行我们自己的切换动画，用户看到的是我们自己的动画。<br>3.手势拖动的时候，盖上自定义的UIImageView(截图View)并且跟着手势平移或者执行动画。<br><a id="more"></a></p>
<h2 id="自定义动画类"><a href="#自定义动画类" class="headerlink" title="自定义动画类"></a>自定义动画类</h2><h3 id="自定义push、pop动画"><a href="#自定义push、pop动画" class="headerlink" title="自定义push、pop动画"></a>自定义push、pop动画</h3><p>关于怎么自定义push和pop动画这一篇不再细说，这一思路也是基于自定义push和pop动画的Demo基础上对自定义动画类做改造。</p>
<h4 id="首先给类扩充一个截图方法"><a href="#首先给类扩充一个截图方法" class="headerlink" title="首先给类扩充一个截图方法"></a>首先给类扩充一个截图方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (UIImage *)screenShot</div><div class="line">&#123;</div><div class="line">  UIViewController *beyondVC = self.navigationController.view.window.rootViewController;</div><div class="line">  CGSize size = beyondVC.view.frame.size;</div><div class="line">  UIGraphicsBeginImageContextWithOptions(size, YES, 0.0);</div><div class="line">  CGRect rect = CGRectMake(0, 0, ScreenWidth, ScreenHeight);</div><div class="line">  [beyondVC.view drawViewHierarchyInRect:rect  afterScreenUpdates:NO];</div><div class="line">  UIImage *snapshot = UIGraphicsGetImageFromCurrentImageContext();</div><div class="line"></div><div class="line">  UIGraphicsEndImageContext();</div><div class="line">  return snapshot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="改造协议方法"><a href="#改造协议方法" class="headerlink" title="改造协议方法"></a>改造协议方法</h4><p>对 -(void)animateTransition:(id)transitionContext；方法做改造<br>transitionContext这个上下文是关键，通过它我们可以拿到切换时的源控制器和目标控制器<br>还有一个很重要的containerView，它是VC切换时候的view容器，即将要切入的view要加入到该view容器中。</p>
<p>切换动画之前的准备代码：</p>
<h5 id="1-截图"><a href="#1-截图" class="headerlink" title="1.截图"></a>1.截图</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">UIImageView * screentImgView = [[UIImageView alloc]initWithFrame:CGRectMake(0, 0, ScreenWidth, ScreenHeight)];</div><div class="line">UIImage * screenImg = [self screenShot];</div><div class="line">screentImgView.image =screenImg;</div></pre></td></tr></table></figure>
<h5 id="2-拿到切换时候的源控制器和目标控制器，以及containerView，和相关的frame"><a href="#2-拿到切换时候的源控制器和目标控制器，以及containerView，和相关的frame" class="headerlink" title="2.拿到切换时候的源控制器和目标控制器，以及containerView，和相关的frame"></a>2.拿到切换时候的源控制器和目标控制器，以及containerView，和相关的frame</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">//取出切换的时候的源控制器和目标控制器</div><div class="line">UIViewController * fromViewController = [transitionContext viewControllerForKey:UITransitionContextFromViewControllerKey];</div><div class="line">UIViewController * toViewController = [transitionContext viewControllerForKey:UITransitionContextToViewControllerKey];</div><div class="line">//提供一个key，返回对应的VC,ToView对应切入的VC。</div><div class="line">UIView * toView = [transitionContext viewForKey:UITransitionContextToViewKey];</div><div class="line">//containerView是VC切换时候的view容器，将要切入的view加入到该view容器中。</div><div class="line">UIView * containerView = [transitionContext containerView];</div><div class="line"></div><div class="line">CGRect fromViewEndFrame = [transitionContext finalFrameForViewController:fromViewController];</div><div class="line">fromViewEndFrame.origin.x = ScreenWidth;</div><div class="line">CGRect fromViewStartFrame = fromViewEndFrame;</div><div class="line">CGRect toViewEndFrame = [transitionContext finalFrameForViewController:toViewController];</div><div class="line">CGRect toViewStartFrame = toViewEndFrame;</div></pre></td></tr></table></figure>
<h4 id="push动画"><a href="#push动画" class="headerlink" title="push动画"></a>push动画</h4><p>我们要做的事情：<br>1.截图加入我们的数组中<br>2.将要切入的View加入到containerView<br>3.截图View插入到window的atIndex:0层<br>4.执行动画<br>5.执行完动画移除截图View</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">if (self.navigationOperation == UINavigationControllerOperationPush) &#123;</div><div class="line"></div><div class="line">  [self.screenShotArray addObject:screenImg];</div><div class="line">  //这句非常重要，没有这句，就无法正常Push和Pop出对应的界面</div><div class="line">  [containerView addSubview:toView];</div><div class="line">  toView.frame = toViewStartFrame;</div><div class="line"></div><div class="line">  //将截图添加到导航栏的View所属的window上</div><div class="line">  [self.navigationController.view.window insertSubview:screentImgView atIndex:0];</div><div class="line">  self.navigationController.view.transform = CGAffineTransformMakeTranslation(ScreenWidth, 0);</div><div class="line"></div><div class="line">  //执行动画</div><div class="line">  [UIView animateWithDuration:[self transitionDuration:transitionContext] animations:^&#123;</div><div class="line"></div><div class="line">    self.navigationController.view.transform = CGAffineTransformMakeTranslation(0, 0);</div><div class="line">    screentImgView.center = CGPointMake(-ScreenWidth / 2, ScreenHeight / 2);</div><div class="line"></div><div class="line">  &#125; completion:^(BOOL finished) &#123;</div><div class="line"></div><div class="line">    [screentImgView removeFromSuperview];</div><div class="line">    [transitionContext completeTransition:YES];</div><div class="line">  &#125;];</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="pop动画"><a href="#pop动画" class="headerlink" title="pop动画"></a>pop动画</h4><p>1.将要切入的View加入到containerView<br>2.数组中最新的截图View：[self.navigationController.view.window addSubview:lastVcImgView];<br>3.pop即将开始时的截图View：[self.navigationController.view addSubview:screentImgView];<br>4.执行动画<br>5.移除截图View,截图数组移除一个最新截图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">if (self.navigationOperation == UINavigationControllerOperationPop) &#123;</div><div class="line"></div><div class="line">   [containerView addSubview:toView];</div><div class="line"></div><div class="line">   UIImageView * lastVcImgView = [[UIImageView alloc]initWithFrame:CGRectMake(-ScreenWidth, 0, ScreenWidth, ScreenHeight)];</div><div class="line">   lastVcImgView.image = [self.screenShotArray lastObject];</div><div class="line">   screentImgView.layer.shadowColor = [UIColor blackColor].CGColor;</div><div class="line">   screentImgView.layer.shadowOffset = CGSizeMake(-0.8, 0);</div><div class="line">   screentImgView.layer.shadowOpacity = 0.6;</div><div class="line">   [self.navigationController.view.window addSubview:lastVcImgView];</div><div class="line">   [self.navigationController.view addSubview:screentImgView];</div><div class="line"></div><div class="line">   [UIView animateWithDuration:[self transitionDuration:transitionContext] animations:^&#123;</div><div class="line"></div><div class="line">     screentImgView.center = CGPointMake(ScreenWidth * 3 / 2 , ScreenHeight / 2);</div><div class="line">     lastVcImgView.center = CGPointMake(ScreenWidth/2, ScreenHeight/2);</div><div class="line"></div><div class="line">   &#125; completion:^(BOOL finished) &#123;</div><div class="line"></div><div class="line">    [lastVcImgView removeFromSuperview];</div><div class="line">    [screentImgView removeFromSuperview];</div><div class="line">    [self.screenShotArray removeLastObject];</div><div class="line">    [transitionContext completeTransition:YES];  </div><div class="line">  &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h4><p>我们这时候写好一些细节就可以得到下面的效果，push和pop时执行的是我们的动画（截图的平移）。</p>
<p><img src="https://raw.githubusercontent.com/MeXuym/hexoSource/master/_posts/XYMNavigation/pushandpop.gif" alt="NativeNavigation"><br>￼<br>但是这时候我们还有手势返回没有实现，接下来就做这个事情。<br>这要求我们对我们的自定义navigationController进行改造</p>
<h2 id="自定义navigationController"><a href="#自定义navigationController" class="headerlink" title="自定义navigationController"></a>自定义navigationController</h2><p>改造这一个类的思路和前面自定义动画类做的事情差不多，差别就在于这里的截图View是跟随手势的移动来平移或执行动画</p>
<h3 id="要做的事情"><a href="#要做的事情" class="headerlink" title="要做的事情"></a>要做的事情</h3><p>1.我们也给这个类扩充一样的截图方法，用一个数组来保存截图。<br>2.根据手势的不同阶段做不同的操作或者动画（开始拖拽阶段、结束拖拽阶段、正在拖拽阶段）。<br>3.push时候截图加入数组，pop的时候对移除数组最新截图。</p>
<h3 id="手势监听"><a href="#手势监听" class="headerlink" title="手势监听"></a>手势监听</h3><p>添加手势的一系列代码，这里不做详细解释，属于基础知识，本篇旨在解析思路和部分核心代码。<br>监听手势的方法,只要是有手势就会执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">- (void)panGestureRec:(UIScreenEdgePanGestureRecognizer *)panGestureRec</div><div class="line">&#123;</div><div class="line">  // 如果当前显示的控制器已经是根控制器了，不需要做任何切换动画,直接返回</div><div class="line">  if(self.visibleViewController == self.viewControllers[0]) return;</div><div class="line"></div><div class="line">  // 判断pan手势的各个阶段</div><div class="line">  switch (panGestureRec.state) &#123;</div><div class="line">    case UIGestureRecognizerStateBegan:</div><div class="line">    // 开始拖拽阶段</div><div class="line">    [self dragBegin];</div><div class="line">    break;</div><div class="line">    case UIGestureRecognizerStateCancelled:</div><div class="line">    case UIGestureRecognizerStateFailed:</div><div class="line">    case UIGestureRecognizerStateEnded:</div><div class="line">    // 结束拖拽阶段</div><div class="line">    [self dragEnd];</div><div class="line">    break;</div><div class="line">    default:</div><div class="line"></div><div class="line">    // 正在拖拽阶段</div><div class="line">    [self dragging:panGestureRec];</div><div class="line">    break;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="拖拽开始"><a href="#拖拽开始" class="headerlink" title="拖拽开始"></a>拖拽开始</h3><p>每次开始Pan手势时,都要添加截图imageview 和 遮盖层coverView到window中<br>imgView显示截图数组中的最后(最新)截图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (void)dragBegin</div><div class="line">&#123;</div><div class="line">  [self.view.window insertSubview:_screenshotImgView atIndex:0];</div><div class="line">  [self.view.window insertSubview:_coverView aboveSubview:_screenshotImgView];</div><div class="line">  _screenshotImgView.image = [_screenshotImgs lastObject];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="拖拽中"><a href="#拖拽中" class="headerlink" title="拖拽中"></a>拖拽中</h3><p>得到手指拖动的位移，让整个截图imageview都平移</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (void)dragging:(UIPanGestureRecognizer *)pan</div><div class="line">&#123;</div><div class="line">  // 得到手指拖动的位移</div><div class="line">  CGFloat offsetX = [pan translationInView:self.view].x;</div><div class="line">  // 让整个view都平移     // 挪动整个导航view</div><div class="line">  if (offsetX &gt; 0) &#123;</div><div class="line">     self.view.transform = CGAffineTransformMakeTranslation(offsetX, 0);</div><div class="line">  &#125;</div><div class="line">  // 计算目前手指拖动位移占屏幕总的宽高的比例,当这个比例达到3/4时, 就让imageview完全显示，遮盖完全消失</div><div class="line">  double currentTranslateScaleX = offsetX/self.view.frame.size.width;</div><div class="line"></div><div class="line">  if (offsetX &lt; ScreenWidth) &#123;</div><div class="line">     _screenshotImgView.transform = CGAffineTransformMakeTranslation((offsetX - ScreenWidth) * 0.6, 0);</div><div class="line">  &#125;</div><div class="line">  // 让遮盖透明度改变,直到减为0,让遮罩完全透明,默认的比例-(当前平衡比例/目标平衡比例)*默认的比例</div><div class="line">  double alpha = kDefaultAlpha - (currentTranslateScaleX/kTargetTranslateScale) * kDefaultAlpha;</div><div class="line">  _coverView.alpha = alpha;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="结束拖拽"><a href="#结束拖拽" class="headerlink" title="结束拖拽"></a>结束拖拽</h3><p>1.得到拖动的距离<br>2.如果手指移动的距离还不到屏幕的一半,往左边挪 (弹回)（执行动画）<br>3.如果手指移动的距离还超过了屏幕的一半,往右边挪（执行动画），执行pop操作，移除截图数组最后一张截图<br>4.操作和动画执行完后都要移除截图的View</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">- (void)dragEnd</div><div class="line">&#123;</div><div class="line">  CGFloat translateX = self.view.transform.tx;</div><div class="line">  CGFloat width = self.view.frame.size.width;</div><div class="line">  if (translateX &lt;= 40) &#123;</div><div class="line">     // 如果手指移动的距离还不到屏幕的一半,往左边挪 (弹回)</div><div class="line">     [UIView animateWithDuration:0.3 animations:^&#123;</div><div class="line">       // 重要~~让被右移的view弹回归位,只要清空transform即可办到</div><div class="line">       self.view.transform = CGAffineTransformIdentity;</div><div class="line">       // 让imageView大小恢复默认的translation</div><div class="line">       _screenshotImgView.transform = CGAffineTransformMakeTranslation(-ScreenWidth, 0);</div><div class="line">       _coverView.alpha = kDefaultAlpha;</div><div class="line"></div><div class="line">     &#125; completion:^(BOOL finished) &#123;</div><div class="line">       [_screenshotImgView removeFromSuperview];</div><div class="line">       [_coverView removeFromSuperview];</div><div class="line">     &#125;];</div><div class="line">  &#125; else &#123;</div><div class="line"></div><div class="line">    // 如果手指移动的距离还超过了屏幕的一半,往右边挪</div><div class="line">    [UIView animateWithDuration:0.3 animations:^&#123;</div><div class="line">      // 让被右移的view完全挪到屏幕的最右边,结束之后,还要记得清空view的transform</div><div class="line">      self.view.transform = CGAffineTransformMakeTranslation(width, 0);</div><div class="line">      // 让imageView位移还原</div><div class="line">      _screenshotImgView.transform = CGAffineTransformMakeTranslation(0, 0);</div><div class="line">      _coverView.alpha = 0;</div><div class="line">  </div><div class="line">    &#125; completion:^(BOOL finished) &#123;</div><div class="line">      // 重要~~让被右移的view完全挪到屏幕的最右边,结束之后,还要记得清空view的transform,不然下次再次开始drag时会出问题,因为view的transform没有归零</div><div class="line">      self.view.transform = CGAffineTransformIdentity;</div><div class="line">      [_screenshotImgView removeFromSuperview];</div><div class="line">      [_coverView removeFromSuperview];</div><div class="line">      [self popViewControllerAnimated:NO];</div><div class="line">      [self.xymAnimation removeLastScreenShot];</div><div class="line">    &#125;];</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="push和pop的时候要做的事情"><a href="#push和pop的时候要做的事情" class="headerlink" title="push和pop的时候要做的事情"></a>push和pop的时候要做的事情</h3><p>1.push的时候截图并保存在数组中<br>2.单次pop的时候移除数组最新一张截图<br>3.pop到指定的VC时移除数组对应的截图<br>4.popToRootVC时移除数组所有截图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">- (void)pushViewController:(UIViewController *)viewController animated:(BOOL)animated</div><div class="line">&#123;</div><div class="line">  // 只有在导航控制器里面有子控制器的时候才需要截图</div><div class="line">  if (self.viewControllers.count &gt;= 1) &#123;</div><div class="line">    // 调用自定义方法,使用上下文截图</div><div class="line">    [self screenShot];</div><div class="line">  &#125;</div><div class="line">    [super pushViewController:viewController animated:animated];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (UIViewController *)popViewControllerAnimated:(BOOL)animated</div><div class="line">&#123;</div><div class="line">  NSInteger index = self.viewControllers.count;</div><div class="line">  NSString * className = nil;</div><div class="line">  if (index &gt;= 2) &#123;</div><div class="line">    className = NSStringFromClass([self.viewControllers[index -2] class]);</div><div class="line">  &#125;</div><div class="line">  if (_screenshotImgs.count &gt;= index - 1) &#123;</div><div class="line">    [_screenshotImgs removeLastObject];</div><div class="line">  &#125;</div><div class="line">  return [super popViewControllerAnimated:animated];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSArray&lt;UIViewController *&gt; *)popToViewController:(UIViewController *)viewController animated:(BOOL)animated</div><div class="line">&#123;</div><div class="line">  NSInteger removeCount = 0;</div><div class="line">  for (NSInteger i = self.viewControllers.count - 1; i &gt; 0; i--) &#123;</div><div class="line">    if (viewController == self.viewControllers[i]) &#123;</div><div class="line">      break;</div><div class="line">    &#125;</div><div class="line">    [_screenshotImgs removeLastObject];</div><div class="line">    removeCount ++;</div><div class="line">  &#125;</div><div class="line">  _animationController.removeCount = removeCount;</div><div class="line">  return [super popToViewController:viewController animated:animated];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSArray&lt;UIViewController *&gt; *)popToRootViewControllerAnimated:(BOOL)animated</div><div class="line">&#123;</div><div class="line">  [_screenshotImgs removeAllObjects];</div><div class="line">  [_animationController removeAllScreenShot];</div><div class="line">  return [super popToRootViewControllerAnimated:animated];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，以上就是解决本篇问题的思路。没有贴出所有的代码和细节，旨在说明这一解决问题的思路</p>
<p><img src="https://raw.githubusercontent.com/MeXuym/hexoSource/master/_posts/XYMNavigation/XYMNavigation.gif" alt="NativeNavigation"></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>这个思路把我的遇到的导航栏的问题解决了。在遇到同类问题的时候，我们同样也可以用自己的自定义转场动画代替或者覆盖掉系统的切换动画，用来规避或者隐藏掉一些问题，希望对各位有用。</p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>Demo：<a href="https://github.com/MeXuym/XYMNavigationController" target="_blank" rel="external">github地址</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.jianshu.com/p/31f177158c9e" target="_blank" rel="external">【简书】让我们一次性解决导航栏的所有问题</a></p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/轮子/" rel="tag">#轮子</a>
          
            <a href="/tags/动画/" rel="tag">#动画</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/12/01/pushAnimation/" rel="next" title="pushAnimation">
                <i class="fa fa-chevron-left"></i> pushAnimation
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/01/04/Hexo多端更新和备份/" rel="prev" title="Hexo多端更新和备份">
                Hexo多端更新和备份 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://raw.githubusercontent.com/MeXuym/hexoSource/master/_posts/avatar/2016.jpg"
               alt="Xuym" />
          <p class="site-author-name" itemprop="name">Xuym</p>
          <p class="site-description motion-element" itemprop="description">Xuym’sBlog</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">11</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#解决思路"><span class="nav-number">1.</span> <span class="nav-text">解决思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义动画类"><span class="nav-number">2.</span> <span class="nav-text">自定义动画类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义push、pop动画"><span class="nav-number">2.1.</span> <span class="nav-text">自定义push、pop动画</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#首先给类扩充一个截图方法"><span class="nav-number">2.1.1.</span> <span class="nav-text">首先给类扩充一个截图方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#改造协议方法"><span class="nav-number">2.1.2.</span> <span class="nav-text">改造协议方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-截图"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">1.截图</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-拿到切换时候的源控制器和目标控制器，以及containerView，和相关的frame"><span class="nav-number">2.1.2.2.</span> <span class="nav-text">2.拿到切换时候的源控制器和目标控制器，以及containerView，和相关的frame</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#push动画"><span class="nav-number">2.1.3.</span> <span class="nav-text">push动画</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pop动画"><span class="nav-number">2.1.4.</span> <span class="nav-text">pop动画</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#运行"><span class="nav-number">2.1.5.</span> <span class="nav-text">运行</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义navigationController"><span class="nav-number">3.</span> <span class="nav-text">自定义navigationController</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#要做的事情"><span class="nav-number">3.1.</span> <span class="nav-text">要做的事情</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手势监听"><span class="nav-number">3.2.</span> <span class="nav-text">手势监听</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拖拽开始"><span class="nav-number">3.3.</span> <span class="nav-text">拖拽开始</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拖拽中"><span class="nav-number">3.4.</span> <span class="nav-text">拖拽中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结束拖拽"><span class="nav-number">3.5.</span> <span class="nav-text">结束拖拽</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#push和pop的时候要做的事情"><span class="nav-number">3.6.</span> <span class="nav-text">push和pop的时候要做的事情</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结语"><span class="nav-number">4.</span> <span class="nav-text">结语</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo"><span class="nav-number">5.</span> <span class="nav-text">Demo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xuym</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("lubvYzC9gbhewL64xJBhzXse-gzGzoHsz", "p7TKWuq9NIvfdB4X3cjVgyLj");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
